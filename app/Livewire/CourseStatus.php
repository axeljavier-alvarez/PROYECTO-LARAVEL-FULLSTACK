<?php

namespace App\Livewire;

use Livewire\Component;
use Illuminate\Support\Facades\DB;
use App\Models\Review;

class CourseStatus extends Component
{

    public $course;

    public $sections;
    public $lessons;

    public $current;

    public $open_lessons;
    public $completed = false;
    public $advance;

    public $review = [
        'open' => false,
        'rating' => 5,
        'comment' => ''

    ];



    public function mount()
    {
        $this->setOpenLessons();
        $this->setCompleted();
        $this->setAdvance();
    }

    public function updated($property, $value)
    {
        if($property == 'completed')
        {
            // dd($value);
            DB::table('course_lesson_user')
            ->where('lesson_id', $this->current->id)
            ->where('user_id', auth()->id())
            ->update(['completed'=> $value]);

            $this->setOpenLessons();
            $this->setAdvance();
        }
    }

    public function setOpenLessons()
    {
        $this->open_lessons= DB::table('course_lesson_user')
        ->where('course_id', $this->course->id)
        ->where('user_id', auth()->id())
        ->whereIn('lesson_id', $this->lessons->pluck('id'))
        ->get();
    }

    public function completedLesson()
    {
         DB::table('course_lesson_user')
            ->where('lesson_id', $this->current->id)
            ->where('user_id', auth()->id())
            ->update(['completed'=> true]);

        $this->nextLesson();

    }

    public function setCompleted()
    {
        if(auth()->check())
        {

        $this->completed = $this->open_lessons
        ->where('lesson_id', $this->current->id)
        ->where('user_id', auth()->id())
        ->where('completed', 1)
        ->count();
        // $open_lessons
        // ->where('lesson_id', $lesson['id'])
        // ->where('user_id', auth()->id())
        // ->where('completed', 1)
        // ->count();


        }

    }


    // nuevo metodo
    public function setAdvance()
    {
        $this->advance = round($this->open_lessons
        ->where('completed', 1)
        ->count() * 100 / ($this->lessons->count()));


    }

    public function previousLesson()
    {
        $index = $this->lessons->pluck('id')->search($this->current->id);

        // dd($index);
        // dd($this->lessons[$index]->toArray());

        if($index == 0){
            $lesson = $this->lessons->last();
        } else {
            $lesson = $this->lessons[$index -1];
        }

        return redirect()->route('courses.status', [$this->course, $lesson->slug]);

    }

    public function nextLesson()
    {
        $index = $this->lessons->pluck('id')->search($this->current->id);

        if($index == $this->lessons->count() -1){
            $lesson = $this->lessons->first();
        } else {
            $lesson = $this->lessons[$index +1];
        }

        return redirect()->route('courses.status', [$this->course, $lesson->slug]);
    }

    public function storeReview()
    {

        $this->validate([
            'review.rating' => 'required',
            'review.comment' => 'required'
        ]);

        Review::create([
            'user_id' => auth()->id(),
            'course_id' => $this->course->id,
            'rating' => $this->review['rating'],
            'comment' => $this->review['comment'],
        ]);

        $this->reset('review');
    }


    public function render()
    {
        return view('livewire.course-status');
    }
}
